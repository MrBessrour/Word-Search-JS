<html>
  <head>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      table td.highlighted {
        background-color: #999;
      }
      table td.found {
        background-color: rgb(255, 0, 0);
      }
      table td.normal {
        background-color: rgb(255, 255, 255);
      }
      p.timer {
        font-size: 30px;
      }
      td.line {
        text-decoration: line-through;
      }
      table.grid {
        cursor: pointer;
        border-collapse: separate;
        border-spacing: 13px;
      }
      table.words {
        cursor: pointer;
        border-collapse: separate;
        border-spacing: 10px;

        font-size: 30px;
        text-align: center;
      }
      table.grid td {
        border: 1px solid black;
        width: 40px;
        height: 40px;
        font-size: 30px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="row" style="padding: 2%">
      <table id="grid" class="grid"></table>
      <p id="timer" class="timer">Timer</p>
    </div>
    <table id="words" class="words" style="padding-left: 2%"></table>
  </body>
  <script>
    const arabic_alpha = [
      "ا",
      "ب",
      "ت",
      "ث",
      "ج",
      "ح",
      "خ",
      "د",
      "ذ",
      "ر",
      "ز",
      "ص",
      "ض",
      "ط",
      "ظ",
      "ع",
      "غ",
      "ف",
      "ق",
      "ک",
      "ل",
      "م",
      "ن",
      "و",
      "ه",
      "ی",
    ];
    var current_word = "";
    var dir = null;
    var prevCell = {
      x: null,
      y: null,
    };
    var currCell = {
      x: null,
      y: null,
    };
    var vector = null;
    var selection = [];

    var grid = [
      ["", "", "", "ة", "ن", "ي", "ف", "س"],
      ["", "", "", "", "", "", "", ""],
      ["", "", "", "ة", "ر", "ئ", "ا", "ط"],
      ["ة", "", "ة", "ت", "خ", "ي", "", ""],
      ["ج", "", "", "ب", "و", "", "", ""],
      ["ا", "", "", "", "ر", "", "", ""],
      ["ر", "", "", "", "ا", "ع", "", ""],
      ["د", "", "", "", "ص", "", "", ""],
    ];
    var words = ["عربة", "سفينة", "طائرة", "صاروخ", "دراجة", "يخت"];
    var found = [];

    function secondsToHMS(s) {
      var h = Math.floor(s / 3600);
      s -= h * 3600;
      var m = Math.floor(s / 60);
      s -= m * 60;
      return h + ":" + (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
    }

    function setup() {
      var html = "";
      for (var i = 0; i < 8; i++) {
        html += "<tr>";
        for (var j = 0; j < 8; j++) {
          html += "<td>" + grid[i][j] + "</td>";
        }
        html += "</tr>";
      }
      $("#grid").append(html);

      var sec = 0;
      setInterval(function () {
        sec++;
        $("#timer").text(secondsToHMS(sec));
      }, 1000);
    }

    function setupWords() {
      var html = "";
      html += "<tr>";
      for (var i = 0; i < words.length / 2; i++) {
        html += "<td id = " + i + ">" + words[i] + "</td>";
      }
      html += "</tr><tr>";

      for (var i = words.length / 2; i < words.length; i++) {
        html += "<td id = " + i + ">" + words[i] + "</td>";
      }

      $("#words").append(html);

      $("#grid tr").each(function () {
        $("td", this).each(function () {
         // console.log($(this).text());
          var randChar =
            arabic_alpha[Math.floor(Math.random() * arabic_alpha.length)];
          if ($(this).text() == "") {
            $(this).text(randChar);
          }
        });
      });
    }

    function undoSelection() {
      $("#grid")
        .find(".found")
        .removeClass("normal")
        .removeClass("highlighted");
      $("#grid")
        .find(".highlighted")
        .addClass("normal")
        .removeClass("highlighted");

      current_word = "";
      dir = null;
      selection = [];
      vector = null;
    }

    function hTest(cCell, pCell) {
      if (cCell.y != pCell.y) return false;
      return true;
    }

    function vTest(cCell, pCell) {
      if (cCell.x != pCell.x) return false;
      return true;
    }

    function dTest(cCell, pCell) {
      if (Math.abs(cCell.x - pCell.x) != Math.abs(cCell.y - pCell.y))
        return false;

      vector = {
        x: cCell.x - pCell.x,
        y: cCell.y - pCell.y,
      };
      return vector;
    }

    function diagTest(cCell, pCell, vector) {
      if (Math.abs(cCell.x - pCell.x) != Math.abs(cCell.y - pCell.y))
        return false;

      if (cCell.x - pCell.x != vector.x) {
        return false;
      }

      if (cCell.y - pCell.y != vector.y) {
        return false;
      }

      return true;
    }
    function wordFound(i) {
      console.log(i) ;
      $("#"+i).addClass("line") ;
      selection.forEach((index) => {
        $("#grid tr")
          .eq(index.y)
          .find("td")
          .eq(index.x)
          .addClass("found")
          .removeClass("normal");
      });
    }

    function checkWord(word) {
      if (words.indexOf(word) > -1) {
        wordFound(words.indexOf(word));
        found.push(word);
        return true;
      }
      return false;
    }

    $(function () {
      var isMouseDown = false;
      $("#grid td")
        .mousedown(function () {
          isMouseDown = true;
          $(this).addClass("highlighted").removeClass("normal");

          prevCell.y = $(this).parent().index();
          prevCell.x = $(this).index();
          selection.push({ x: prevCell.x, y: prevCell.y });

          currCell.y = $(this).parent().index();
          currCell.x = $(this).index();

          current_word += $(this).text();

          return false; // prevent text selection
        })
        .mouseover(function () {
          if (isMouseDown) {
            if ($(this).attr("class") != "highlighted") {
              prevCell = { x: currCell.x, y: currCell.y };

              currCell.y = $(this).parent().index();
              currCell.x = $(this).index();
              selection.push({ x: currCell.x, y: currCell.y });

              if (dir == null) {
                if (hTest(currCell, prevCell)) dir = 1;
                if (vTest(currCell, prevCell)) dir = 0;
                vector = dTest(currCell, prevCell);
                if (vector != false) {
                  dir = 2;
                }
              }
              switch (dir) {
                case 0:
                  if (!vTest(currCell, prevCell)) {
                    undoSelection();
                  }
                  break;

                case 1:
                  if (!hTest(currCell, prevCell)) {
                    undoSelection();
                  }
                  break;
                case 2:
                  if (!diagTest(currCell, prevCell, vector)) {
                    undoSelection();
                  }
                  break;
                default:
                  break;
              }
              current_word += $(this).text();
              checkWord(current_word);
              //console.log(current_word);

              // console.log(current_word) ;
            }

            $(this).addClass("highlighted").removeClass("normal");
          }
        });

      $(document).mouseup(function () {
        isMouseDown = false;
        undoSelection();
      });
    });

    setup();
    setupWords();
  </script>
</html>
